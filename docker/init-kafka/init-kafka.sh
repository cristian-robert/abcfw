#!/bin/bash
set -e

echo "=== Waiting for Kafka to be ready ==="
cub kafka-ready -b kafka:29092 1 60

echo "=== Waiting for Schema Registry to be ready ==="
while ! curl -s http://schema-registry:8081/subjects > /dev/null 2>&1; do
  echo "Schema Registry not ready yet, retrying in 2s..."
  sleep 2
done
echo "Schema Registry is ready"

echo "=== Creating topics ==="
kafka-topics --create --if-not-exists \
  --bootstrap-server kafka:29092 \
  --topic billing-engine-inbound \
  --partitions 1 \
  --replication-factor 1

kafka-topics --create --if-not-exists \
  --bootstrap-server kafka:29092 \
  --topic billing-engine-outbound \
  --partitions 1 \
  --replication-factor 1

echo "Topics created:"
kafka-topics --list --bootstrap-server kafka:29092

echo "=== Registering inbound Avro schema (TransactionCreated) ==="
curl -s -X POST http://schema-registry:8081/subjects/billing-engine-inbound-value/versions \
  -H "Content-Type: application/vnd.schemaregistry.v1+json" \
  -d '{
  "schema": "{\"type\":\"record\",\"name\":\"TransactionCreated\",\"namespace\":\"test.prof.events\",\"fields\":[{\"name\":\"header\",\"type\":{\"type\":\"record\",\"name\":\"ProfileEventHeader\",\"fields\":[{\"name\":\"headerVersion\",\"type\":\"string\"},{\"name\":\"messageId\",\"type\":\"string\"},{\"name\":\"aggregateId\",\"type\":\"string\"},{\"name\":\"occurrenceDate\",\"type\":\"string\"},{\"name\":\"actor\",\"type\":\"string\"},{\"name\":\"source\",\"type\":\"string\"},{\"name\":\"eventType\",\"type\":\"string\"},{\"name\":\"eventTypeVersion\",\"type\":\"string\"}]}},{\"name\":\"body\",\"type\":{\"type\":\"record\",\"name\":\"TransactionCreatedBody\",\"fields\":[{\"name\":\"transactionIdentifierSequence\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"accountNumber\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"systemDate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"branch\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"externalTransactionCode\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"debitCreditFlag\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"skipStatementFlag\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"errorCorrectionFlag\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"reversalFlag\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"amount\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"interestAmount1\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"penaltiesAmount\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"taxOnInterestAmount\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"otherChargesAmount\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"endingBalanceAmount\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"userId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionCurrency\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"Rate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionEffectiveDate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionLineOfPosting\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"calendarDate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionComment2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionDetails1\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionDetails2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionDetails3\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionDetails4\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cardNumber\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"authorizationCode\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cardType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"incomingFileNameOrCaptureUser\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"contextLogId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"sequenceOfFile\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"dateOfCapture\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"fromAccountNumber\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"fromFinancialInstitution\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"orderingPartyName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"interestAmount2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantCityName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantCountry\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionComment\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"details1\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"details2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantTerminal\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"toAccountNumber\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"referenceNumber\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"sequenceReversalTransaction\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"toFinancialInstitution\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"receivingPartyName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionSource\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentSequenceNumber\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentReferenceNumber\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"toAccountCurrency\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"toAccountCurrencyAmount\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionFrom\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionAmount\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionAmountExponent\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionSlip\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionTo\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"originalOrderedAccount\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"correspondentServiceFee1\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"correspondentServiceFee2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"correspondentServiceFee3\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cardNumber2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"serviceFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"accountActivationBonus\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"ecommerceAdministrationFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"accountAdministrationFee1\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"slipNumber\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"beneficiary\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"beneficiaryInstitution\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"swiftCode\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"beneficiaryInstitution1\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"beneficiaryInstitution2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"beneficiaryInstitution3\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"beneficiaryInstitution4\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"campaign\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"accountAdministrationFee2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"country\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cardMembershipFee1\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cardMembershipFee2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"initialTransactionDate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"incomeTaxForUtilitiesPaymentBonus\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"posMaintenanceFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"serviceFee1\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"serviceFee2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"lowValueGarnishmentPaymentFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"highValueGarnishmentPaymentFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"loanLinkedCurrentAccount\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"chargeDetail1\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"ingFixedOfferOrFixedFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"ingFixedCompleteOfferFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"ingFixedOfferFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"interestPaymentOption\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"interestAmount3\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantCategoryCode\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"maturityDate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"merchantName2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"effectiveAmount\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"loanClosing\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"accountOpeningFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"ecommerceInstallationFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"senderName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"ownerOfFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cardMemberPan\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"topPhoneNumber\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"processOwnForUtilitiesPayment\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"nonbankTransactionBonus\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"advocateCompingBonus\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"allCardsCompingBonus\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"multipleCompingBonus\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"purposeCode\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"supplementaryVerificationFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"reportingLine1\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"reportingLine2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"rolloverAmount\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"settlementAmount\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"masServiceFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"alertServiceMonthlyFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"smsServiceFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"valueDate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"ingRate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"dueFrom\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transferFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"statementFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"rate2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"abcGoldOptionOpeningFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"abcGoldOptionAdministrationFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"comment1\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"principal\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"transactionDate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"refundFreeTransfersFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"travelOptionAdministrationFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"empowered\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"homebankingMonthlyServiceFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"taxOnInterest\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"accountAdministrationFee3\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"accountAdministrationFee4\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"accountOpeningFee1\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"accountOpeningFee2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"accountOpeningFee3\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"accountOpeningFee4\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cardIssuanceFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cardMembershipFeesNet\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"extractRollFileAnalysisFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"accountStatementMailingFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"webLogId\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"thirdPartyProviderName\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"availableBalance\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"marketRate\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"negotiatedRateIndicator\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"fiscalRegistrationNumber\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"sepaCustomerReference\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"isSepaFlag\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"comment2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"comment3\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"comment4\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"details3\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"details4\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"feeForUrgentPayment\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"depositor\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cashLimitUpdateFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"cardIssuanceFee2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"vodafoneRechargeCommission\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"vodafoneRechargeCommission2\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"orangeRechargeCommission\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"telecouRechargeCommission\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"instantCreditSellOfFee\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"accountType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"currency\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"initChannel\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"urgencyType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"btcCode\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"paymentType\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"endToEndId\",\"type\":[\"null\",\"string\"],\"default\":null}]}}]}"
}'

echo ""
echo "Inbound schema registered"

echo "=== Registering outbound Avro schema (BillingResponse) ==="
curl -s -X POST http://schema-registry:8081/subjects/billing-engine-outbound-value/versions \
  -H "Content-Type: application/vnd.schemaregistry.v1+json" \
  -d '{
  "schema": "{\"type\":\"record\",\"name\":\"BillingResponse\",\"namespace\":\"test.billing.events\",\"fields\":[{\"name\":\"GeneralInformation\",\"type\":{\"type\":\"array\",\"items\":{\"type\":\"record\",\"name\":\"InfoEntry\",\"fields\":[{\"name\":\"value\",\"type\":[\"null\",\"string\"],\"default\":null}]}}}]}"
}'

echo ""
echo "Outbound schema registered"

echo "=== Verifying registered schemas ==="
curl -s http://schema-registry:8081/subjects
echo ""

echo "=== Init complete ==="
